!addplugindir Instdrv/NSIS/Plugins
!addincludedir Instdrv/NSIS/Includes
!include x64.nsh
!include java.nsh
!include refresh-sh.nsh

!define REG_NAME "Altus Metrum"
!define PROG_ID	     "org.altusmetrum.altosui.1"
!define PROG_ALTOSUI "org.altusmetrum.altosui.1"
!define FAT_NAME "altosui-fat.jar"
!define ICO_ICO "altus-metrum.ico"
!define ICO_EXE "altus-metrum.exe"

Name "${REG_NAME} Installer"

; Default install directory
InstallDir "$PROGRAMFILES\AltusMetrum"

; Tell the installer where to re-install a new version
InstallDirRegKey HKLM "Software\${REG_NAME}" "Install_Dir"

LicenseText "GNU General Public License Version 2"
LicenseData "../COPYING"

; Need admin privs for Vista or Win7
RequestExecutionLevel admin

ShowInstDetails Show

ComponentText "${REG_NAME} Software and Driver Installer"

Function .onInit
	DetailPrint "Checking host operating system"
	${If} ${RunningX64}
		DetailPrint "Installer running on 64-bit host"
		SetRegView 64
		StrCpy $INSTDIR "$PROGRAMFILES64\AltusMetrum"
		${DisableX64FSRedirection}
	${EndIf}
FunctionEnd

Function un.onInit
	DetailPrint "Checking host operating system"
	${If} ${RunningX64}
		DetailPrint "Installer running on 64-bit host"
		SetRegView 64
		StrCpy $INSTDIR "$PROGRAMFILES64\AltusMetrum"
		${DisableX64FSRedirection}
	${EndIf}
FunctionEnd

; Pages to present

Page license
Page components
Page directory
Page instfiles

UninstPage uninstConfirm
UninstPage instfiles

; And the stuff to install

Section "Install Driver" InstDriver

	InstDrv::InitDriverSetup /NOUNLOAD {4D36E96D-E325-11CE-BFC1-08002BE10318} AltusMetrumSerial
	Pop $0
	DetailPrint "InitDriverSetup: $0"
	InstDrv::DeleteOemInfFiles /NOUNLOAD
	InstDrv::CreateDevice /NOUNLOAD

	SetOutPath $INSTDIR
	File "../altusmetrum.inf"
	File "../altusmetrum.cat"

	${DisableX64FSRedirection}
	IfFileExists $WINDIR\System32\PnPutil.exe 0 nopnp
		${DisableX64FSRedirection}
		nsExec::ExecToLog '"$WINDIR\System32\PnPutil.exe" -i -a "$INSTDIR\altusmetrum.inf"'
		Goto done
nopnp:
		InstDrv::InstallDriver /NOUNLOAD "$INSTDIR\altusmetrum.inf"
done:

SectionEnd

Section "${REG_NAME} Application"
	Call DetectJRE

	SetOutPath $INSTDIR

	File "${FAT_NAME}"
	File "altoslib_@ALTOSLIB_VERSION@.jar"
	File "altosuilib_@ALTOSUILIB_VERSION@.jar"
	File "cmudict04.jar"
	File "cmulex.jar"
	File "cmu_time_awb.jar"
	File "cmutimelex.jar"
	File "cmu_us_kal.jar"
	File "en_us.jar"
	File "freetts.jar"
	File "jfreechart.jar"
	File "jcommon.jar"

	File "*.dll"

	File "../icon/${ICO_ICO}"

	CreateShortCut "$SMPROGRAMS\${REG_NAME}.lnk" "$SYSDIR\javaw.exe" "-jar ${FAT_NAME}" "$INSTDIR\${ICO_ICO}"
SectionEnd

Section "${REG_NAME} Desktop Shortcut"
	CreateShortCut "$DESKTOP\${REG_NAME}.lnk" "$INSTDIR\${FAT_NAME}"  "" "$INSTDIR\${ICO_ICO}"
SectionEnd

Section "TeleMetrum, TeleDongle and TeleBT Firmware"

	SetOutPath $INSTDIR

	File "../src/telemetrum-v1.0/telemetrum-v1.0-${VERSION}.ihx"
	File "../src/telemetrum-v1.1/telemetrum-v1.1-${VERSION}.ihx"
	File "../src/telemetrum-v1.2/telemetrum-v1.2-${VERSION}.ihx"
	File "../src/telemini-v1.0/telemini-v1.0-${VERSION}.ihx"
	File "../src/telegps-v1.0/telegps-v1.0-${VERSION}.ihx"
	File "../src/teledongle-v0.2/teledongle-v0.2-${VERSION}.ihx"
	File "../src/telebt-v1.0/telebt-v1.0-${VERSION}.ihx"
	File "../src/telemega-v1.0/telemega-v1.0-${VERSION}.ihx"
	File "../src/easymini-v1.0/easymini-v1.0-${VERSION}.ihx"

SectionEnd

Section "Documentation"

	SetOutPath $INSTDIR

	File "../doc/altusmetrum.pdf"
	File "../doc/altos.pdf"
	File "../doc/telemetry.pdf"
	File "../doc/telemetrum-outline.pdf"
	File "../doc/telemega-outline.pdf"
	File "../doc/easymini-outline.pdf"
	File "../doc/telemini.pdf"
SectionEnd

Section "File Associations"

	SetOutPath $INSTDIR

	File "../icon/${ICO_EXE}"

	; application elements
	
	WriteRegStr HKCR "${PROG_ID}"			""				"Altus Metrum Data File"
	WriteRegStr HKCR "${PROG_ID}"			"FriendlyTypeName"		"Altus Metrum Data File"
	WriteRegStr HKCR "${PROG_ID}\CurVer"		""				"${PROG_ID}"
	WriteRegStr HKCR "${PROG_ID}\DefaultIcon"	""				'"$INSTDIR\${ICO_EXE}",-101'
  WriteRegExpandStr HKCR "${PROG_ID}\shell\play\command" ""				'"%SYSTEMROOT%\System32\javaw.exe" -Djava.library.path="$INSTDIR" -jar "$INSTDIR\${FAT_NAME}" "%1"'

	; .eeprom elements

	WriteRegStr HKCR ".eeprom"			""				"${PROG_ALTOSUI}"
	WriteRegStr HKCR ".eeprom"			"PerceivedType"			"Altus Metrum Log File"
	WriteRegStr HKCR ".eeprom"			"Content Type"			"application/altosui"

	WriteRegStr HKCR ".eeprom\OpenWithProgids"	"${PROG_ID}"			""
	WriteRegStr HKCR ".eeprom\${PROG_ID}"		""				"${REG_NAME}"
	
	; .telem elements
	
	WriteRegStr HKCR ".telem"			""				"${PROG_ALTOSUI}"
	WriteRegStr HKCR ".telem"			"PerceivedType"			"Altus Metrum Telemetry File"
	WriteRegStr HKCR ".telem"			"Content Type"			"application/altosui"

	WriteRegStr HKCR ".telem\OpenWithProgids"	"${PROG_ID}"			""
	WriteRegStr HKCR ".telem\${PROG_ID}"		""				"${REG_NAME}"

	Call RefreshShellIcons
SectionEnd
	
Section "Uninstaller"

	; Deal with the uninstaller

	${DisableX64FSRedirection}
	SetOutPath $INSTDIR

	; Write the install path to the registry
	WriteRegStr HKLM "SOFTWARE\${REG_NAME}" "Install_Dir" "$INSTDIR"

	; Write the uninstall keys for windows
	WriteRegStr HKLM "SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\${REG_NAME}" "DisplayName" "${REG_NAME}"
	WriteRegStr HKLM "SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\${REG_NAME}" "UninstallString" '"$INSTDIR\uninstall-${REG_NAME}.exe"'
	WriteRegStr HKLM "SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\${REG_NAME}" "NoModify" "1"
	WriteRegStr HKLM "SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\${REG_NAME}" "NoRepair" "1"

	WriteUninstaller "uninstall-${REG_NAME}.exe"
SectionEnd

Section "Uninstall"

	${DisableX64FSRedirection}

	DeleteRegKey   HKLM "SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\${REG_NAME}"
	DeleteRegKey   HKLM "SOFTWARE\${REG_NAME}"

	DetailPrint "Delete uninstall reg entries"

	DeleteRegKey   HKCR "${PROG_ID}"

	DeleteRegKey   HKCR ".eeprom\${PROG_ID}"
	DeleteRegValue HKCR ".eeprom\OpenWithProgids" "${PROG_ID}"

	DeleteRegKey   HKCR ".telem\${PROG_ID}"
	DeleteRegValue HKCR ".telem\OpenWithProgids" "${PROG_ID}"

	DetailPrint "Delete file association reg entries"

	Delete "$INSTDIR\${FAT_NAME}"
	Delete "$INSTDIR\uninstall-${REG_NAME}.exe"

	Delete "$INSTDIR\${ICO_ICO}"
	Delete "$INSTDIR\${ICO_EXE}"

	; Remove shortcuts, if any
	Delete "$SMPROGRAMS\${REG_NAME}.lnk"
	Delete "$DESKTOP\${REG_NAME}.lnk"
	
	Call un.RefreshShellIcons
SectionEnd
